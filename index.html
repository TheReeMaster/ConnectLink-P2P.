<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectLink - P2P Social Feed</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background-color: #f8f8f8; }
        h1 { color: #5B2C6F; text-align: center; border-bottom: 2px solid #5B2C6F; padding-bottom: 10px; }
        .info-box { background: #e0f7fa; border: 1px solid #00bcd4; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        #my-id-container { text-align: center; margin-bottom: 20px; }
        #my-peer-id { font-size: 1.2em; font-weight: bold; color: #D50000; }
        #connection-area input, #connection-area button { padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #ccc; }
        #connection-area button { background-color: #4CAF50; color: white; cursor: pointer; border: none; }
        #connection-area button:hover { background-color: #45a049; }
        #message-input, #send-button { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        #send-button { background-color: #8E44AD; color: white; cursor: pointer; border: none; }
        #send-button:hover { background-color: #6C3483; }
        #messages { list-style-type: none; padding: 0; }
        .message-item { background-color: #fff; padding: 10px; margin-bottom: 8px; border-left: 5px solid #8E44AD; border-radius: 4px; word-wrap: break-word; }
        .message-sender { font-weight: bold; color: #333; }
        .message-content { margin-top: 5px; }
    </style>
</head>
<body>

    <h1>ConnectLink P2P Feed</h1>
    <div class="info-box">
        This app uses **Peer-to-Peer (P2P)** technology. Posts are sent directly to connected users and are **not** stored permanently. To connect, share your ID and have a friend enter it below!
    </div>

    <div id="my-id-container">
        Your P2P ID: <strong id="my-peer-id">...Generating...</strong>
    </div>

    <div id="connection-area">
        <input type="text" id="target-id" placeholder="Enter Peer ID to Connect">
        <button onclick="connectToPeer()">Connect</button>
        <div id="connected-count" style="margin-top: 10px;">Connected Peers: 0</div>
    </div>

    <hr>
    
    <h2>Share a Link</h2>
    <textarea id="message-input" placeholder="Type your link or message here (max 280 chars)" maxlength="280" disabled></textarea>
    <button id="send-button" onclick="sendMessage()" disabled>Send Link</button>

    <h2>Received Links</h2>
    <ul id="messages"></ul>

<script>
    let peer; 
    let connections = {};
    const PEER_SERVER_HOST = '0.peerjs.com'; 

    // --- UTILITIES ---
    function updateConnectedCount() {
        document.getElementById('connected-count').innerText = `Connected Peers: ${Object.keys(connections).length}`;
    }

    function displayMessage(senderId, content) {
        const messagesUl = document.getElementById('messages');
        const li = document.createElement('li');
        li.className = 'message-item';
        
        const timestamp = new Date().toLocaleTimeString();
        
        li.innerHTML = `
            <div class="message-sender">From ${senderId} at ${timestamp}:</div>
            <div class="message-content">${content}</div>
        `;
        messagesUl.prepend(li);
    }

    // --- P2P CONNECTION LOGIC ---

    function initializePeer() {
        peer = new Peer({
            host: PEER_SERVER_HOST,
            secure: true, 
            port: 443
        });

        // 1. Peer ID is ready
        peer.on('open', (id) => {
            document.getElementById('my-peer-id').innerText = id;
            console.log('My P2P ID is:', id);
            
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;

            // 2. Listen for connection requests from other peers
            peer.on('connection', handleIncomingConnection);
        });

        // 3. Handle errors
        peer.on('error', (err) => {
            console.error('PeerJS Error:', err);
            document.getElementById('my-peer-id').innerText = 'ERROR: Check console.';
        });
    }
    
    // Function to manually connect to another peer (User A's action)
    function connectToPeer() {
        const targetId = document.getElementById('target-id').value.trim();
        if (!targetId || targetId === peer.id) return alert("Please enter a valid, different Peer ID.");
        
        if (connections[targetId] && connections[targetId].open) return alert("Already connected to this peer!");

        const conn = peer.connect(targetId);
        
        conn.on('open', () => {
            // Store the connection object immediately for sending data
            connections[targetId] = conn; 
            setupConnectionListeners(conn);
            alert(`Successfully connected to peer: ${targetId}!`);
            updateConnectedCount();
        });
        
        conn.on('error', (err) => console.error(`Connection failed for ${targetId}:`, err));
    }

    // Function to handle connection established by an incoming request (User B's action)
    function handleIncomingConnection(conn) {
        // ðŸš¨ FIX HERE: This ensures User B sets up listeners and stores the connection object.
        // The sender needs a handler for 'open', the receiver needs a handler for 'data'.
        
        conn.on('open', () => {
            if (!connections[conn.peer] || !connections[conn.peer].open) {
                connections[conn.peer] = conn; // Store the incoming connection for sending data back
                setupConnectionListeners(conn);
                alert(`New peer connected: ${conn.peer}`);
                updateConnectedCount();
            }
        });
    }

    // Sets up listeners for receiving data and closing connections
    function setupConnectionListeners(conn) {
        // Data listener (Receiving)
        conn.on('data', (data) => {
            if (data.sender && data.content) {
                displayMessage(data.sender, data.content);
                console.log(`Received data from ${data.sender}: ${data.content}`);
            } else {
                console.warn('Received malformed data:', data);
            }
        });
        
        // Disconnect listener
        conn.on('close', () => {
            delete connections[conn.peer];
            displayMessage('SYSTEM', `Peer ${conn.peer} disconnected.`);
            updateConnectedCount();
        });
    }

    // --- SENDING LOGIC ---

    function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!content) return;
        
        const messageData = { 
            sender: peer.id, 
            content: content
        };

        let sentCount = 0;
        let wasSent = false;
        
        // Loop through all active data connections
        for (const peerId in connections) {
            const conn = connections[peerId];
            // Check if the connection is open and ready to transmit
            if (conn && conn.open) { 
                conn.send(messageData);
                sentCount++;
                wasSent = true;
                console.log(`Sending message to ${peerId}`);
            }
        }
        
        if (wasSent) {
            // Display the message locally immediately after sending
            displayMessage('YOU', content);
            input.value = ''; // Clear input
            console.log(`Echo sent to ${sentCount} peers.`);
        } else {
            alert("No open connections found! Please connect to a peer first.");
        }
    }

    // Start the app when the page loads
    initializePeer();
</script>

</body>
</html>
